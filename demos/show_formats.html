<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Parse all Photoshop PSD formats</title>
	<style>
		body {background:#aaa;}
		.psd {background:#ddd;display:inline-block;width:180px;margin:0 4px 4px 0;padding:4px}
		.psd > p {font:bold 14px sans-serif;padding:4px;margin:0;box-sizing: border-box}
		.psd > div {margin:4px;font:12px monospace;white-space: pre}
		#loader {
			position:fixed;
			left:0;
			top:0;
			width:100%;
			height:7px;
			padding:10px 0;
			box-sizing: border-box;
			z-index:1000;
			}
		#loader>div {
			margin:0;
			box-sizing: border-box;
			border:#99f;
			background:#77f;
			width:0;
			padding:4px 0;
			}
	</style>
</head>
<body>

<div id="loader"><div id="prog"></div></div>
<div id="files"></div>

<script src="../psd-reader.min.js"></script>
<script>

var files = [
	    "epistemex_RGB8.psd",
	    "epistemex_RGB16.psd",
	    "epistemex_RGB32.psd",
	    "epistemex_RGBA8.psd",
	    "epistemex_RGBA16.psd",
	    "epistemex_RGBA32.psd",
		"epistemex_bitmap.psd",
	    "epistemex_CMYK8.psd",
	    "epistemex_CMYK16.psd",
		"epistemex_CMYKA8.psd",
	    "epistemex_CMYKA16.psd",
	    "epistemex_DUO8.psd",
		"epistemex_G8.psd",
	    "epistemex_G16.psd",
	    "epistemex_G32.psd",
		"epistemex_GA8.psd",
	    "epistemex_GA16.psd",
	    "epistemex_GA32.psd",
		"epistemex_indexed32.psd",
		"epistemex_indexed32A.psd",
		"epistemex_indexed256.psd",
	    "epistemex_LAB8.psd",
	    "epistemex_LAB16.psd",
		"epistemex_LABA8.psd",
	    "epistemex_LABA16.psd",
	    "epistemex_MultiChannel.psd"
	],
    psds = [],
	count = files.length, i = 0, loaded = 0,
    filesDiv = document.getElementById("files"),
    progCont = document.getElementById("loader"),
    prog = document.getElementById("prog");

	// load files in bulks to avoid errors with XML requests
	function next() {
		if (i < count) psds.push(new LoadPSD(files[i++]));
		if (i < count) psds.push(new LoadPSD(files[i++]));
		if (i < count) psds.push(new LoadPSD(files[i++]));
		if (i < count) psds.push(new LoadPSD(files[i++]));
		if (i < count) psds.push(new LoadPSD(files[i++]));
		if (i < count) psds.push(new LoadPSD(files[i++]));
		prog.style.width = (i / count * 100) + "%";
	}
	next(); // invoke first bulk

	/*
	This is called whe the buffer has been loaded, but before parsing.
	Since we use passive mode in this demo, we have to invoke parsing
	manually.
	 */
	function onready() {
		loaded++;
		if (loaded === count) {                 // start parsing when all files has loaded
			var t = 0, len = psds.length;
			progCont.style.display = "none";
			while(t < len) psds[t++].parse();
		}
		else if (loaded === i) {                // bulk loaded? load next bulk
			next();
		}
	}

	function LoadPSD(url) {

		var psd = new PsdReader({
			    url:"gfx/" + url,
			    passive: true,                  // use passive mode so we get loaded in order
			    onload: onload,
				onready: onready,               // to keep track of loads before manual parsing
			    onerror: error
		    }),
		    div = document.createElement("div");

		div.className = "psd";
		filesDiv.appendChild(div);

		this.parse = function() {               // expose this instance's parse method
			psd.parse();
		};

		function onload() {
			var canvas = psd.toCanvas();        // convert to canvas, build rest of the tile:

			var p = document.createElement("p"),
				info = document.createElement("div");

			info.innerHTML = "Width   : " + psd.info.width +
					"<br>Height  : " + psd.info.height +
					"<br>Depth   : " + psd.info.depth +
					"<br>Mode    : " + psd.info.colorDesc +
					(psd.info.indexes ? " (" + psd.info.indexes + ")" : "") +
					"<br>Compr.  : " + psd.info.compressionDesc +
					"<br>Channels: " + psd.info.channels;

			p.innerHTML = url.substring(url.indexOf("_") + 1, url.indexOf(".psd"));
			div.appendChild(p);
			div.appendChild(canvas);
			div.appendChild(info);

		}
	}

	function error(e) {console.log(e)}

</script>
</body>
</html>
