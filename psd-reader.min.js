/*
	psd-reader version 0.3.0 BETA

	By Epistemex (c) 2015
	www.epistemex.com

	MIT license (this header required)
*/
function PsdReader(e){if(typeof e==="string"){e={url:e}}else{e=e||{}}var d=this,a={url:e.url||"",buffer:e.buffer||null,crossOrigin:typeof e.crossOrigin=="boolean"?!!e.crossOrigin:null,onError:e.onError||e.onerror,onLoad:e.onLoad||e.onload,gamma:+e.gamma||1,gamma32:+e.gamma32||PsdReader.guessGamma()};this._cfg=a;this.onload=a.onLoad?a.onLoad.bind(this):null;this.onerror=a.onError?a.onError.bind(this):null;this.buffer=a.buffer?ArrayBuffer.isView(a.buffer)?a.buffer.buffer:a.buffer:null;this.rgba=null;this.info={width:0,height:0,channels:0,depth:0,indexes:0,byteWidth:0,colorMode:0,colorDesc:"",compression:0,compressionDesc:"",channelSize:0,chunks:[],bitmaps:[]};if((!a.url||typeof a.url!=="string"||(a.url&&!a.url.length))&&!this.buffer){c("No data buffer or URL is specified.","core");return}else{if(a.url&&this.buffer){c("Both URL and a data buffer is specified.","core");return}}this._err=function(f,g){c(f,g)};try{if(a.url){this._fetch(a.url,function(f){d.buffer=f;d.view=new DataView(f);d._parser(d.buffer)},function(f){c(f,"_fetch")})}else{this._parser(this.buffer)}}catch(b){c(b.message,"core")}function c(g,h){if(d.onerror){setTimeout(f.bind(d),1)}else{throw new TypeError(g)}function f(){d.onerror({message:g,source:h,timeStamp:Date.now()})}}}PsdReader.prototype={_fetch:function(e,a,c){try{var f=new XMLHttpRequest(),d=this;f.open("GET",e);f.responseType="arraybuffer";f.onerror=function(){d._err("Network error.","fetch/onerror")};f.onload=function(){if(f.status===200){a(f.response)}else{d.error("Loading error: "+f.statusText,"fetch/onload")}};f.send()}catch(b){this.error(b.message,"fetch/catch")}}};PsdReader.guessGamma=function(){return 1/((navigator.userAgent.indexOf("Mac OS")>-1)?1.8:2.2)};PsdReader._blockSize=2048*1024;PsdReader._delay=7;PsdReader.prototype._parser=function(b){var w=this,D=new DataView(b),z=0,v=l(),C=n(),A,r,d,f,E,q,h,x,y,e,t,u,B=performance?performance.now():Date.now(),s=this.info;this.findResource=j;if(v!=="8BPS"&&C!==1){this._err("Not PSD file.","parser");return}for(A=k(6),r=0;r<6;r++){if(A[r]){this._err("Not a valid PSD file.","parser");return}}a("Header",14);d=n();if(d<1||d>56){this._err("Invalid channel count.","parser");return}q=o();E=o();if(E<1||E>30000||q<1||q>30000){this._err("Invalid size.","parser");return}h=n();if([1,8,16,32].indexOf(h)<0){this._err("Invalid depth.","parser");return}x=n();if(x<0||x>15){this._err("Invalid color mode.","parser");return}y=["Bitmap","Greyscale","Indexed","RGB","CMYK","HSL","HSB","Multichannel","Duotone","Lab","Greyscale16","RGB48","LAB48","CMYK64","DeepMultichannel","Duotone16"][x];s.channels=d;s.width=E;s.height=q;s.depth=h;s.byteWidth=h/8;s.colorMode=x;s.colorDesc=y;s.channelSize=E*q*s.byteWidth;e=o();a("ColorModeData",e);z+=e;if((x===2||x===8)&&e===0){this._err("Invalid data for this mode.","parser");return}t=o();a("ImageResource",t);z+=t;u=o();a("LayersAndMasks",u);z+=u;a("ImageData",D.buffer.byteLength-z);f=n();s.compression=f;s.compressionDesc=["Uncompressed","RLE","ZIP","ZIP"][f];switch(f){case 0:this._raw(D,z,s,g);break;case 1:this._rle(D,z,s,g);break;case 2:case 3:console.warn("If you come across this, consider sending us a specimen of this file for analysis.");break}function g(){w._toRGBA(c)}function c(i){w._gamma(i);w.rgba=i;if(w.onload){w.onload({timeStamp:Date.now(),elapsed:(performance?performance.now():Date.now())-B})}}function j(F){var i=s.chunks[2],J,I=0,H,K,G;if(!i.length){return null}G=((F&65280)>>>8)|((F&255)<<8);J=new Uint16Array(w.buffer,i.pos,i.length>>>1);H=J.length;while(I<H){K=J[I++];if(K===16952){K=J[I++];if(K===19785){K=J[I++];if(K===G){z=J.byteOffset+(I<<1);return{offset:z,id:F,name:m(),len:o(),pos:z}}}}}return null}function a(F,i){s.chunks.push({pos:z,name:F,length:i})}function p(){return D.getUint8(z++)}function n(){var i=D.getUint16(z);z+=2;return i>>>0}function o(){var i=D.getUint32(z);z+=4;return i>>>0}function k(F){var i=new Uint8Array(b,z,F);z+=F;return i}function m(H){var I="",F=-1,G=0;H=H||255;while(G++<H&&F){F=p();if(F>0){I+=String.fromCharCode(F)}}if(!I.length||I.length%2===0){z++}return I}function l(F){var G=o(),i=String.fromCharCode;return F?i((G&255)>>>0)+i((G&65280)>>>8)+i((G&16711680)>>>16)+i((G&4278190080)>>>24):i((G&4278190080)>>>24)+i((G&16711680)>>>16)+i((G&65280)>>>8)+i((G&255)>>>0)}};PsdReader.prototype._rle=function(o,m,l,c){var d=0,k=l.channels,a=PsdReader._blockSize,n=new Uint8Array(o.buffer),h=o.buffer.byteLength,e=l.height*l.channels,b=new Uint16Array(e);while(d<e){b[d++]=j()}d=0;(function f(){var i=new Uint8Array(l.channelSize);l.bitmaps.push(i);g(n,i);a-=i.length;if(--k){if(a>0){f()}else{a=PsdReader._blockSize;setTimeout(f,PsdReader._delay)}}else{c()}})();function g(u,i){var t=0,q=l.height;while(q--){var r,w,s=Math.min(m+b[d++],h);while(m<s){r=u[m++];if(r>128){r=257-r;w=u[m++];while(r--){i[t++]=w}}else{if(r<128){r++;while(r--){i[t++]=u[m++]}}}}}}function j(){var i=o.getUint16(m);m+=2;return i}};PsdReader.prototype._raw=function(f,e,c,a){for(var b=0,d=c.channelSize;b<c.channels;b++,e+=d){c.bitmaps.push(new Uint8Array(f.buffer,e,d))}a()};PsdReader.prototype._toRGBA=function(h){var q=this.info,e=new Uint8ClampedArray(q.width*q.height<<2),s=e.length,u=q.colorMode,j=q.depth,f=q.byteWidth,w,l,d,c,o,v;switch(u){case 0:this._bitmap(q.bitmaps[0],e,q.width);h(e);return;case 1:w=l=d=q.bitmaps[0];c=q.bitmaps[1]||null;break;case 2:this._indexed(q.bitmaps[0],e);h(e);return;case 3:case 4:case 5:case 6:w=q.bitmaps[0];l=q.bitmaps[1];d=q.bitmaps[2];c=q.bitmaps[4]||q.bitmaps[3]||null;break;case 7:w=q.bitmaps[0];l=q.bitmaps[1];d=q.bitmaps[2];break;case 8:h(null);return;case 9:this._lab(e);h(e);return}v=0;if(j===32){w=this.channelToDataView(w);if(l){l=this.channelToDataView(l)}if(d){d=this.channelToDataView(d)}if(c){c=this.channelToDataView(c)}var m=this._cfg.gamma32,t=this.getGammaLUT(m),k=this.floatToComp;if(c){if(u===3){for(o=0;o<s;v+=f){e[o++]=t[k(w,v)];e[o++]=t[k(l,v)];e[o++]=t[k(d,v)];e[o++]=t[k(c,v)]}}else{if(u===1){for(o=0;o<s;v+=f){var n=t[(w.getFloat32(v)*255+0.5)|0];e[o++]=n;e[o++]=n;e[o++]=n;e[o++]=c.getFloat32(v)*255}}}}else{for(o=0;o<s;v+=f){e[o++]=t[k(w,v)];e[o++]=t[k(l,v)];e[o++]=t[k(d,v)];e[o++]=255}}}else{if(c){for(o=0;o<s;v+=f){e[o++]=w[v];e[o++]=l[v];e[o++]=d[v];e[o++]=c[v]}}else{for(o=0;o<s;v+=f){e[o++]=w[v];e[o++]=l[v];e[o++]=d[v];e[o++]=255}}}h(e)};PsdReader.prototype._indexed=function(h,b){var f=h.length,j=this.getIndexTable(),c=this.indexToInt,m=new Uint32Array(b.buffer),d=0,e,a,g=-1,k=-1,n,l=this.findResource(1047);if(l){n=new DataView(this.buffer,l.pos,2);k=n.getInt16(0)}while(d<f){e=h[d];a=c(j,e);if(e===k){a&=16777215}m[d++]=a;if(e>g){g=e}}this.info.indexes=++g};PsdReader.prototype._bitmap=function(e,a,h){var g=new Uint32Array(a.buffer),d=e.length,c=0,f=0;while(c<d){g[f++]=b();if(f%h===0){c=Math.ceil(c)}}function b(){var i=e[c|0],j=(c-(c|0))/0.125;c+=0.125;return(i&(128>>>j))?4278190080:4294967295}};PsdReader.prototype._lab=function(f){var l=this.info.bitmaps[0],c=this.info.bitmaps[1],e=this.info.bitmaps[2],g=this.info.byteWidth,d=this.info.bitmaps[3]||null,j=!!d,n=f.length,h,k=0,o=0;for(;k<n;o+=g){h=m(l[o],c[o],e[o]);f[k++]=h[0];f[k++]=h[1];f[k++]=h[2];f[k++]=j?d[o]:255}function m(s,i,p){s/=2.55;i=128-i;p=128-p;var w=(s+16)/116,u=i/500+w,C=w-p/200,v=Math.pow(u,3),A=Math.pow(w,3),D=Math.pow(C,3),t,r,q;w=(A>0.008855999999999999?A:(w-16/116)/7.787);u=(v>0.008855999999999999?v:(u-16/116)/7.787)*0.950456;C=(D>0.008855999999999999?D:(C-16/116)/7.787)*1.088754;t=u*3.2406+w*-1.5372+C*-0.4986;r=u*-0.9689+w*1.8758+C*0.0415;q=u*0.0557+w*-0.204+C*1.057;t=t>0.0031308?1.055*Math.pow(t,1/2.4)-0.055:12.92*t;r=r>0.0031308?1.055*Math.pow(r,1/2.4)-0.055:12.92*r;q=q>0.0031308?1.055*Math.pow(q,1/2.4)-0.055:12.92*q;return[(q*255+0.5)|0,(r*255+0.5)|0,(t*255+0.5)|0]}};PsdReader.prototype._gamma=function(a){if(!a){return}var c=this._cfg.gamma,b=this.info.depth,e,d,f;if(c&&c!==1&&b<32){f=this.getGammaLUT(c);e=a.length;d=0;while(d<e){a[d]=f[a[d++]];a[d]=f[a[d++]];a[d]=f[a[d++]];d++}}};PsdReader.prototype.toCanvas=function(){if(!this.rgba){return null}var a=document.createElement("canvas"),b=a.getContext("2d"),d;try{a.width=this.info.width;a.height=this.info.height;d=b.createImageData(a.width,a.height);d.data.set(this.rgba);b.putImageData(d,0,0)}catch(c){this._err("Could not create canvas","toCanvas")}return a};PsdReader.prototype.getIndexTable=function(){var a=this.info.chunks[1];if(a.length){return new Uint8Array(this.buffer,a.pos,a.length)}return null};PsdReader.prototype.indexToInt=function(b,a){return 4278190080+(b[a+512]<<16)+(b[a+256]<<8)+b[a]};PsdReader.prototype.channelToDataView=function(a){return new DataView(a.buffer,a.byteOffset,a.byteLength)};PsdReader.prototype.getGammaLUT=function(a){var c=new Uint8ClampedArray(256),b;for(b=0;b<256;b++){c[b]=(Math.pow(b/255,a)*255+0.5)|0}return c};PsdReader.prototype.floatToComp=function(a,b){return(a.getFloat32(b)*255+0.5)|0};