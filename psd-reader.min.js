/*
	psd-reader version 0.2.1 BETA

	By Epistemex (c) 2015
	www.epistemex.com

	MIT license (this header required)
*/
function PsdReader(e){if(typeof e==="string"){e={url:e}}else{e=e||{}}var d=this,a={url:e.url||"",buffer:e.buffer||null,crossOrigin:typeof e.crossOrigin=="boolean"?!!e.crossOrigin:null,onError:e.onError||e.onerror,onLoad:e.onLoad||e.onload};this.onload=a.onLoad?a.onLoad.bind(this):null;this.onerror=a.onError?a.onError.bind(this):null;this.buffer=a.buffer?ArrayBuffer.isView(a.buffer)?a.buffer.buffer:a.buffer:null;this.rgba=null;this.info={};if((!a.url||typeof a.url!=="string"||(a.url&&!a.url.length))&&!this.buffer){c("No data buffer or URL is specified.","core");return}else{if(a.url&&this.buffer){c("Both URL and a data buffer is specified.","core");return}}this._err=function(f,g){c(f,g)};try{if(a.url){this._fetch(a.url,function(f){d.buffer=f;d.view=new DataView(f);d._parser(d.buffer)},function(f){c(f,"_fetch")})}else{this._parser(this.buffer)}}catch(b){c(b.message,"core")}function c(g,h){if(d.onerror){setTimeout(f.bind(d),1)}else{throw new TypeError(g)}function f(){d.onerror({message:g,source:h,timeStamp:Date.now()})}}}PsdReader.prototype={_fetch:function(e,a,c){try{var f=new XMLHttpRequest(),d=this;f.open("GET",e);f.responseType="arraybuffer";f.onerror=function(){d._err("Network error.","fetch/onerror")};f.onload=function(){if(f.status===200){a(f.response)}else{d.error("Loading error: "+f.statusText,"fetch/onload")}};f.send()}catch(b){this.error(b.message,"fetch/catch")}}};PsdReader._blockSize=2048*1024;PsdReader._delay=7;PsdReader.prototype._parser=function(b){var t=this,A=new DataView(b),w=0,s=k(),z=l(),x,o,d,f,B,n,h,u,v,e,q,r,y=performance?performance.now():Date.now(),p={width:0,height:0,channels:0,depth:0,byteWidth:0,colorMode:0,colorDesc:"",compression:0,compressionDesc:"",channelSize:0,chunks:[],bitmaps:[]};this.info=p;this.rgba=null;if(s!=="8BPS"&&z!==1){this._err("Not PSD file.","parser");return}for(x=j(6),o=0;o<6;o++){if(x[o]){this._err("Not a valid PSD file.","parser");return}}a("Header",14);d=l();if(d<1||d>56){this._err("Invalid channel count.","parser");return}n=m();B=m();if(B<1||B>30000||n<1||n>30000){this._err("Invalid size.","parser");return}h=l();if([1,8,16,32].indexOf(h)<0){this._err("Invalid depth.","parser");return}u=l();if(u<0||u>15){this._err("Invalid color mode.","parser");return}v=["Bitmap","Greyscale","Indexed","RGB","CMYK","HSL","HSB","Multichannel","Duotone","Lab","Greyscale16","RGB48","LAB48","CMYK64","DeepMultichannel","Duotone16"][u];p.channels=d;p.width=B;p.height=n;p.depth=h;p.byteWidth=h/8;p.colorMode=u;p.colorDesc=v;p.channelSize=B*n*p.byteWidth;e=m();a("ColorModeData",e);w+=e;if((u===2||u===8)&&e===0){this._err("Invalid data for this mode.","parser");return}q=m();a("ImageResource",q);w+=q;r=m();a("LayersAndMasks",r);w+=r;a("ImageData",A.buffer.byteLength-w);f=l();p.compression=f;p.compressionDesc=["Uncompressed","RLE","ZIP","ZIP"][f];switch(f){case 0:this._raw(A,w,p,g);break;case 1:this._rle(A,w,p,g);break;case 2:case 3:console.warn("If you come across this, consider sending us a specimen of this file for analysis.");break}function g(){t._toRGBA(c)}function c(i){t.rgba=i;if(t.onload){t.onload({timeStamp:Date.now(),elapsed:(performance?performance.now():Date.now())-y})}}function a(C,i){p.chunks.push({pos:w,name:C,length:i})}function l(){var i=A.getUint16(w);w+=2;return i>>>0}function m(){var i=A.getUint32(w);w+=4;return i>>>0}function j(C){var i=new Uint8Array(b,w,C);w+=C;return i}function k(C){var D=m(),i=String.fromCharCode;return C?i((D&255)>>>0)+i((D&65280)>>>8)+i((D&16711680)>>>16)+i((D&4278190080)>>>24):i((D&4278190080)>>>24)+i((D&16711680)>>>16)+i((D&65280)>>>8)+i((D&255)>>>0)}};PsdReader.prototype._rle=function(o,m,l,c){var d=0,k=l.channels,a=PsdReader._blockSize,n=new Uint8Array(o.buffer),h=o.buffer.byteLength,e=l.height*l.channels,b=new Uint16Array(e);while(d<e){b[d++]=j()}d=0;(function f(){var i=new Uint8Array(l.channelSize);l.bitmaps.push(i);g(n,i);a-=i.length;if(--k){if(a>0){f()}else{a=PsdReader._blockSize;setTimeout(f,PsdReader._delay)}}else{c()}})();function g(u,i){var t=0,q=l.height;while(q--){var r,w,s=Math.min(m+b[d++],h);while(m<s){r=u[m++];if(r>128){r=257-r;w=u[m++];while(r--){i[t++]=w}}else{if(r<128){r++;while(r--){i[t++]=u[m++]}}}}}}function j(){var i=o.getUint16(m);m+=2;return i}};PsdReader.prototype._raw=function(f,e,c,a){for(var b=0,d=c.channelSize;b<c.channels;b++,e+=d){c.bitmaps.push(new Uint8Array(f.buffer,e,d))}a()};PsdReader.prototype._toRGBA=function(h){var y=this,u=this.info,e=new Uint8ClampedArray(u.width*u.height<<2),w=e.length,z=u.colorMode,j=u.depth,f=u.byteWidth,B,n,d,c,s,A;switch(z){case 0:k(u.bitmaps[0],e,u.width<<2);h(e);return;case 1:B=n=d=u.bitmaps[0];c=u.bitmaps[1]||null;break;case 2:l(u.bitmaps[0],e,u.chunks[1]);h(e);return;case 3:case 4:case 5:case 6:B=u.bitmaps[0];n=u.bitmaps[1];d=u.bitmaps[2];c=u.bitmaps[4]||u.bitmaps[3]||null;break;case 7:B=u.bitmaps[0];n=u.bitmaps[1];d=u.bitmaps[2];break;case 8:h(null);return;case 9:m(e);h(e);return}A=0;if(j===32){B=new DataView(y.buffer,B.byteOffset,B.byteLength);if(n){n=new DataView(y.buffer,n.byteOffset,n.byteLength)}if(d){d=new DataView(y.buffer,d.byteOffset,d.byteLength)}if(c){c=new DataView(y.buffer,c.byteOffset,c.byteLength)}var o=1/((navigator.userAgent.indexOf("Mac OS")>-1)?1.8:2.2),x=new Uint8Array(256),C=0;for(;C<256;C++){x[C]=(Math.pow(C/255,o)*255+0.5)|0}if(c){if(z===3){for(s=0;s<w;A+=f){e[s++]=x[(B.getFloat32(A)*255+0.5)|0];e[s++]=x[(n.getFloat32(A)*255+0.5)|0];e[s++]=x[(d.getFloat32(A)*255+0.5)|0];e[s++]=x[(c.getFloat32(A)*255+0.5)|0]}}else{if(z===1){for(s=0;s<w;A+=f){var q=x[(B.getFloat32(A)*255+0.5)|0];e[s++]=q;e[s++]=q;e[s++]=q;e[s++]=c.getFloat32(A)*255}}}}else{for(s=0;s<w;A+=f){e[s++]=x[(B.getFloat32(A)*255+0.5)|0];e[s++]=x[(n.getFloat32(A)*255+0.5)|0];e[s++]=x[(d.getFloat32(A)*255+0.5)|0];e[s++]=255}}}else{if(c){for(s=0;s<w;A+=f){e[s++]=B[A];e[s++]=n[A];e[s++]=d[A];e[s++]=c[A]}}else{for(s=0;s<w;A+=f){e[s++]=B[A];e[s++]=n[A];e[s++]=d[A];e[s++]=255}}}h(e);function l(G,r,a){var F=G.length,b=a.length,p=b/3,g=p*2,I=new Uint8Array(y.buffer,a.pos,b),D=0,H=0,E;while(D<F){E=G[D++];r[H++]=I[E];r[H++]=I[E+p];r[H++]=I[E+g];r[H++]=255}}function k(E,g,G){var D=E.length,r=0,F=0,a;while(r<D){a=p();g[F++]=a;g[F++]=a;g[F++]=a;g[F++]=255;if(F%G===0){r=Math.ceil(r)}}function p(){var i=E[r|0],t=(r-(r|0))/0.125;r+=0.125;return(i&(128>>>t))?0:255}}function m(D){var G=u.bitmaps[0],g=u.bitmaps[1],t=u.bitmaps[2],r=u.bitmaps[3]||null,E,F=0,H=0;if(r){for(;F<w;H+=f){E=v(G[H],g[H],t[H]);D[F++]=E[0];D[F++]=E[1];D[F++]=E[2];D[F++]=r[H]}}else{for(;F<w;H+=f){E=v(G[H],g[H],t[H]);D[F++]=E[0];D[F++]=E[1];D[F++]=E[2];D[F++]=255}}}function v(t,g,i){t/=2.55;g=128-g;i=128-i;var H=(t+16)/116,E=g/500+H,J=H-i/200,F=Math.pow(E,3),I=Math.pow(H,3),K=Math.pow(J,3),D,r,p;H=(I>0.008855999999999999?I:(H-16/116)/7.787);E=(F>0.008855999999999999?F:(E-16/116)/7.787)*0.950456;J=(K>0.008855999999999999?K:(J-16/116)/7.787)*1.088754;D=E*3.2406+H*-1.5372+J*-0.4986;r=E*-0.9689+H*1.8758+J*0.0415;p=E*0.0557+H*-0.204+J*1.057;D=D>0.0031308?1.055*Math.pow(D,1/2.4)-0.055:12.92*D;r=r>0.0031308?1.055*Math.pow(r,1/2.4)-0.055:12.92*r;p=p>0.0031308?1.055*Math.pow(p,1/2.4)-0.055:12.92*p;return[(D*255+0.5)|0,(r*255+0.5)|0,(p*255+0.5)|0]}};PsdReader.prototype.toCanvas=function(){if(!this.rgba){return null}var a=document.createElement("canvas"),b=a.getContext("2d"),d;try{a.width=this.info.width;a.height=this.info.height;d=b.createImageData(a.width,a.height);d.data.set(this.rgba);b.putImageData(d,0,0)}catch(c){this._err("Could not create canvas","toCanvas")}return a};