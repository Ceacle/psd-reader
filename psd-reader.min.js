/*
	psd-reader version 1.0.0

	By Epistemex (c) 2015
	www.epistemex.com

	MIT license (this header required)
*/
function PsdReader(g){g=g||{};var e=this,f,b={url:g.url||"",buffer:g.buffer||null,onError:g.onError||g.onerror,onLoad:g.onLoad||g.onload,onReady:g.onReady||g.onready,gamma:+g.gamma||1,gamma32:+g.gamma32||PsdReader.guessGamma(),duotone:g.duotone||[255,255,255],passive:!!g.passive,ignoreAlpha:!!g.ignoreAlpha,toRGBA:d(g.toRGBA,!0),dematte:d(g.dematte,!0)};this.config=b;this.isParsed=!1;this._isp=!1;this.onready=f=b.onReady?b.onReady.bind(e):null;this.onload=b.onLoad?b.onLoad.bind(e):null;this.onerror=b.onError?b.onError.bind(e):null;this.buffer=b.buffer||null;this.rgba=null;this.info={width:0,height:0,channels:0,depth:0,indexes:0,hasAlpha:!1,byteWidth:0,colorMode:0,colorDesc:"",compression:0,compressionDesc:"",channelSize:0,chunks:[],resources:[],bitmaps:[]};this._err=function(h,j){e._isp=!1;if(e.onerror){setTimeout(i.bind(e),1)}else{throw new TypeError(h)}function i(){e.onerror({message:h,source:j,timeStamp:Date.now()})}};function a(h){e._err(h,"core")}if((!b.url||typeof b.url!=="string"||(b.url&&!b.url.length))&&!e.buffer){a("Buffer nor URL specified");return}else{if(b.url&&e.buffer){a("Both URL and buffer specified");return}}try{if(b.url){e._fetch(b.url,function(h){e.buffer=h;e.view=new DataView(h);if(f){f({url:b.url,timeStamp:Date.now()})}if(!e.config.passive){e._parser(e.buffer)}},a)}else{if(f){f({url:null,timeStamp:Date.now()})}if(!e.config.passive){e._parser(e.buffer)}}}catch(c){a(c.message)}function d(h,i){return typeof h=="boolean"?h:i}}PsdReader.prototype={parse:function(){var a=this;if(!a.isParsed&&!a._isp){a._parser(a.buffer)}},toRGBA:function(a){var c=this,b=a.bind(c);c._toRGBA(function(d){c.rgba=d;b({rgba:c.rgba,timeStamp:Date.now()})})},getIndexTable:function(){var a=this.info.chunks[1];return a.length?new Uint8Array(this.buffer,a.pos,a.length):null},indexToInt:function(c,b,a){var d=4278190080+(c[b+512]<<16)+(c[b+256]<<8)+c[b];return a?d&16777215:d},getGammaLUT:function(a){var c=new Uint8ClampedArray(256),b=0;if(a===1){while(b<256){c[b]=b++}}else{for(;b<256;b++){c[b]=(Math.pow(b/255,a)*255+0.5)|0}}return c},floatToComp:function(a,b){return(a.getFloat32(b)*255+0.5)|0},_fetch:function(d,a,c){var e=new XMLHttpRequest();try{e.open("GET",d);e.responseType="arraybuffer";e.onerror=function(){c("Network error")};e.onload=function(){if(e.status===200){a(e.response)}else{c(e.statusText)}};e.send()}catch(b){c(b.message)}},_chanToDV:function(a){return new DataView(a.buffer,a.byteOffset,a.byteLength)}};PsdReader.guessGamma=function(){return 1/((navigator.userAgent.indexOf("Mac OS")<0)?2.2:1.8)};PsdReader._bSz=1<<21;PsdReader._delay=7;PsdReader.prototype._parser=function(c){var u=this,C=new DataView(c),y=0,z=!1,t=k(),B=m(),e,g,D,p,i,v,w,f,r,s,A=performance?performance.now():Date.now(),q=this.info;u._isp=!0;this.findResource=j;this.parseResources=x;if(t!=="8BPS"&&B!==1){a("Not a PSD file");return}if(n()||m()){a("Not a valid PSD file");return}b("Header",14);e=m();if(!e||e>56){a("Invalid channel count");return}p=n();D=n();if(!D||D>30000||!p||p>30000){a("Invalid size");return}i=m();if([1,8,16,32].indexOf(i)<0){a("Invalid depth");return}v=m();if(v>15){a("Invalid color mode");return}if([5,6,11,12,13,14,15].indexOf(v)>-1){a("Unsupported color mode");return}w=["Bitmap","Greyscale","Indexed","RGB","CMYK","HSL","HSB","Multichannel","Duotone","Lab","Greyscale16","RGB48","LAB48","CMYK64","DeepMultichannel","Duotone16"][v];q.channels=e;q.width=D;q.height=p;q.depth=i;q.byteWidth=i/8;q.colorMode=v;q.colorDesc=w;q.channelSize=D*p*q.byteWidth;f=n();b("ColorModeData",f);y+=f;if((v===2||v===8)&&f===0){a("Missing data for mode");return}r=n();b("ImageResource",r);y+=r;s=n();b("LayersAndMasks",s);y+=s;b("ImageData",C.buffer.byteLength-y);g=m();q.compression=g;q.compressionDesc=["Uncompressed","RLE","ZIP","ZIP"][g];switch(g){case 0:u._raw(C,y,q,h);break;case 1:u._rle(C,y,q,h);break;case 2:case 3:a("Unsupported compression");break}function h(){u.config.toRGBA?u._toRGBA(d):d(null)}function d(E){u.rgba=E;u.isParsed=!0;u._isp=!1;if(u.onload){u.onload({timeStamp:Date.now(),elapsed:(performance?performance.now():Date.now())-A})}}function j(F){var H=q.resources,E=0,G;if(!z){x()}while(G=H[E++]){if(G.id===F){return G}}return null}function x(){var E=q.chunks[2],F,G=q.resources,H;if(!E.length){return}y=E.pos;F=y+E.length;z=!0;while(y<F){if(k()==="8BIM"){G.push({id:m(),name:l(256),size:(H=n()),pos:y});y+=H%2===0?H:H+1}else{return}}}function b(F,E){q.chunks.push({pos:y,name:F,length:E})}function o(){return C.getUint8(y++)}function m(){var E=C.getUint16(y);y+=2;return E>>>0}function n(){var E=C.getUint32(y);y+=4;return E>>>0}function l(H){var I="",E=-1,F=0,G;while(F++<H&&E){E=o();if(E>0){I+=String.fromCharCode(E)}}G=I.length;if(!G||G%2===0){y++}return I}function k(){var F=n(),E=String.fromCharCode;return E((F&4278190080)>>>24)+E((F&16711680)>>>16)+E((F&65280)>>>8)+E((F&255)>>>0)}function a(E){u._err(E,"parser")}};PsdReader.prototype._rle=function(o,m,l,c){var d=0,k=l.channels,a=PsdReader._bSz,n=new Uint8Array(o.buffer),h=o.buffer.byteLength,e=l.height*l.channels,b=new Uint16Array(e);while(d<e){b[d++]=j()}d=0;(function f(){var i=new Uint8Array(l.channelSize);l.bitmaps.push(i);g(n,i,h);a-=i.length;if(--k){if(a>0){f()}else{a=PsdReader._bSz;setTimeout(f,PsdReader._delay)}}else{c()}})();function g(x,i,q){var w=0,t,y,u,s=l.height,r;while(s--){u=Math.min(m+b[d++],q);while(m<u){t=x[m++];if(t>128){t=257-t;y=x[m++];r=w+t;while(w<r){i[w++]=y}}else{if(t<128){r=w+ ++t;while(w<r){i[w++]=x[m++]}}}}}}function j(){var i=o.getUint16(m);m+=2;return i}};PsdReader.prototype._raw=function(f,e,c,a){for(var b=0,d=c.channelSize;b<c.channels;b++,e+=d){c.bitmaps.push(new Uint8Array(f.buffer,e,d))}a()};PsdReader.prototype._toRGBA=function(d){var k=this,j=k.info,e=k.config,a=j.bitmaps,b=j.byteWidth,c=k._chanToDV.bind(k),h=k.getGammaLUT,g=k.floatToComp,l=j.width,i=e.ignoreAlpha,f=new Uint8ClampedArray(l*j.height<<2);switch(j.colorMode){case 0:i=k._bitmap(a[0],f,l);break;case 1:i=k._grey(a,f,b,i,c,h,g);break;case 2:i=k._indexed(a[0],f,i);break;case 4:i=k._cmyk(a,f,b,i);break;case 8:i=k._duotone(a,f,i);break;case 9:i=k._lab(a,f,b,i);break;default:i=k._rgba(a,f,b,i,c,h,g)}j.hasAlpha=i;k._gamma(f,j.depth===32?e.gamma32:e.gamma);(i&&e.dematte)?k._dematte(f,d):d(f)};PsdReader.prototype._rgba=function(e,j,f,q,h,m,k){var t=this,s=j.length,o=0,u=0,v=e[0],l=e[1],d=e[2],c=e[3],n=!!c&&!q;if(t.info.depth===32){v=h(v);l=h(l);d=h(d);if(n){c=h(c)}while(o<s){j[o++]=k(v,u);j[o++]=k(l,u);j[o++]=k(d,u);j[o++]=n?k(c,u):255;u+=f}}else{while(o<s){j[o++]=v[u];j[o++]=l[u];j[o++]=d[u];j[o++]=n?c[u]:255;u+=f}}return n};PsdReader.prototype._cmyk=function(e,h,f,n){var s=h.length,m=0,t=0,u=e[0],j=e[1],d=e[2],o=e[3],c=e[4],q,l=!!c&&!n;while(m<s){q=o[t]/255;h[m++]=u[t]*q+0.5;h[m++]=j[t]*q+0.5;h[m++]=d[t]*q+0.5;h[m++]=l?c[t]:255;t+=f}return l};PsdReader.prototype._grey=function(c,f,d,o,e,k,h){var s=new Uint32Array(f.buffer),q=s.length,n=0,r=0,j,b,l,m;j=c[0];b=c[1];m=!!b&&!o;if(this.info.depth<32){while(n<q){l=j[r];s[n++]=((m?b[r]:255)<<24)|(l<<16)|(l<<8)|l;r+=d}}else{j=e(j);if(m){b=e(b)}while(n<q){l=h(j,r);s[n++]=((m?h(b,r):255)<<24)|(l<<16)|(l<<8)|l;r+=d}}return m};PsdReader.prototype._indexed=function(j,b,d){var h=this,f=j.length,k=h.getIndexTable(),n=new Uint32Array(b.buffer),c=0,e,a,g=-1,l=-1,m=d?null:h.findResource(1047);if(m){l=new DataView(h.buffer,m.pos,2).getInt16(0)}while(c<f){e=j[c];a=h.indexToInt(k,e,e===l);n[c++]=a;if(e>g){g=e}}h.info.indexes=++g;return !1};PsdReader.prototype._bitmap=function(f,a,j){var h=new Uint32Array(a.buffer),d=f.length,c=0,g=0,e=j;while(c<d){while(g<e){h[g++]=b(c);c+=0.125}c=Math.ceil(c);e+=j}function b(m){var k=f[m|0],l=(m-(m|0))/0.125;return(k&(128>>l))?4278190080:4294967295}return !1};PsdReader.prototype._duotone=function(d,e,l){var q=d[0],a=d[1],j=!!a&&!l,s=this.config.duotone,h,o=s[0]/255,f=s[1]/255,c=s[2]/255,k=0,n=0,m=q.length;while(k<m){h=q[k];e[n++]=h*o+0.5;e[n++]=h*f+0.5;e[n++]=h*c+0.5;e[n++]=j?a[k]:255;k++}return j};PsdReader.prototype._lab=function(f,j,g,m){var n=f[0],c=f[1],e=f[2],d=f[3],k=!!d&!m,q=j.length,h,l=0,r=0;for(;l<q;r+=g,l+=4){h=o(n[r]/2.55,c[r]-128,e[r]-128,j,l);j[l+3]=k?d[r]:255}function o(A,p,s,u,w){var F=(A+16)/116,D=p/500+F,I=F-s/200,E=Math.pow(D,3),H=Math.pow(F,3),J=Math.pow(I,3),C,v,t;F=(H>0.0088561?H:(F-0.137931)/7.787);D=(E>0.0088561?E:(D-0.137931)/7.787)*0.950456;I=(J>0.0088561?J:(I-0.137931)/7.787)*1.088754;C=D*3.2406+F*-1.5372+I*-0.4986;v=D*-0.9689+F*1.8758+I*0.0415;t=D*0.0557+F*-0.204+I*1.057;C=C>0.0031308?1.055*Math.pow(C,0.41667)-0.055:12.92*C;v=v>0.0031308?1.055*Math.pow(v,0.41667)-0.055:12.92*v;t=t>0.0031308?1.055*Math.pow(t,0.41667)-0.055:12.92*t;u[w++]=C*255;u[w++]=v*255;u[w]=t*255}return k};PsdReader.prototype._gamma=function(a,b){if(!a||!b||b===1){return}var c=0,d=a.length,e=this.getGammaLUT(b);while(c<d){a[c]=e[a[c++]];a[c]=e[a[c++]];a[c]=e[a[c++]];c++}};PsdReader.prototype._dematte=function(b,d){var f=0,g=b.length,c=PsdReader._bSz,a=c;(function e(){var h,i;while(f<g&&a--){h=b[f+3];if(h&&h<255){h/=255;i=255*(1-h);b[f]=(b[f++]-i)/h+0.5;b[f]=(b[f++]-i)/h+0.5;b[f]=(b[f++]-i)/h+0.5;f++}else{f+=4}}if(f<g){a=c;setTimeout(e,PsdReader._delay)}else{d(b)}})()};PsdReader.prototype.toCanvas=function(k){if(!this.rgba){return null}k=k||{};var i=this,a=document.createElement("canvas"),b=a.getContext("2d"),g,q,r,o,m=k.scale||1,f=!!k.hq,s=i.info.width,e=i.info.height,l,j,p=(s*m+0.5)|0,n=(e*m+0.5)|0,d="Could not create canvas";try{a.width=s;a.height=e;g=b.createImageData(s,e);g.data.set(i.rgba);b.putImageData(g,0,0)}catch(c){i._err(d,"toCanvas")}try{if(m!==1){q=document.createElement("canvas");r=q.getContext("2d");if(f&&p<s&&n<e){s=q.width=Math.ceil(s*0.5);e=q.height=Math.ceil(e*0.5);r.drawImage(a,0,0,s,e);o=Math.ceil(Math.log(a.width/p)/Math.log(2))-1;if(o>0){while(o--){l=s;j=e;s=Math.ceil(s*0.5);e=Math.ceil(e*0.5);r.drawImage(q,0,0,l,j,0,0,s,e)}}a.width=p;a.height=n;b.drawImage(q,0,0,s,e,0,0,p,n)}else{q.width=p;q.height=n;r.drawImage(a,0,0,p,n);a=q}}}catch(c){i._err(d,"toCanvas/s")}return a};