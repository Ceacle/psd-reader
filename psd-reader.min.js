/*
	psd-reader version 0.1.0 BETA

	By Epistemex (c) 2015
	www.epistemex.com

	MIT license (this header required)
*/
function PsdReader(e){if(typeof e==="string"){e={url:e}}else{e=e||{}}var d=this,a={url:e.url||"",buffer:e.buffer||null,crossOrigin:typeof e.crossOrigin=="boolean"?!!e.crossOrigin:null,onError:e.onError||e.onerror,onLoad:e.onLoad||e.onload};this.onload=a.onLoad?a.onLoad.bind(this):null;this.onerror=a.onError?a.onError.bind(this):null;this.buffer=a.buffer?ArrayBuffer.isView(a.buffer)?a.buffer.buffer:a.buffer:null;this.rgba=null;this.info={};if((!a.url||typeof a.url!=="string"||(a.url&&!a.url.length))&&!this.buffer){c("No data buffer or URL is specified.","core");return}else{if(a.url&&this.buffer){c("Both URL and a data buffer is specified.","core");return}}try{if(a.url){this.fetch(a.url,function(f){d.buffer=f;d.view=new DataView(f);d.parser(d.buffer)},function(f){c(f,"fetch")})}else{this.parser(this.buffer)}}catch(b){console.error(b)}this._err=function(f,g){c(f,g)};function c(g,h){if(d.onerror){setTimeout(f.bind(d),1)}else{throw new TypeError(g)}function f(){d.onerror({message:g,source:h,timeStamp:Date.now()})}}}PsdReader.prototype={fetch:function(d,a,c){try{var e=new XMLHttpRequest();e.open("GET",d);e.responseType="arraybuffer";e.onerror=function(){c("Network error.")};e.onload=function(){if(e.status===200){a(e.response)}else{c("Loading error: "+e.statusText)}};e.send()}catch(b){c(b.message)}}};PsdReader._blockSize=2048*1024;PsdReader._delay=7;PsdReader.prototype.parser=function(b){var u=this,B=new DataView(b),x=0,t=l(),A=m(),y,p,d,g,f,C,o,j,v,w,e,r,s,z=performance?performance.now():Date.now(),q={maxCompatibility:!0,width:0,height:0,channels:0,depth:0,byteWidth:0,colorMode:0,colorDesc:"",compression:0,compressionDesc:"",channelSize:0,chunks:[],resources:[],layers:[],bitmaps:[]};this.info=q;this.rgba=null;if(t!=="8BPS"&&A!==1){this._err("Not PSD file.","parser");return}for(y=k(6),p=0;p<6;p++){if(y[p]){this._err("Not a valid PSD file.","parser");return}}a("Header",14);d=m();if(d<1||d>56){this._err("Invalid channel count.","parser");return}o=n();C=n();if(C<1||C>30000||o<1||o>30000){this._err("Invalid size.","parser");return}j=m();if([1,8,16,32].indexOf(j)<0){this._err("Invalid depth.","parser");return}v=m();if(v<0||v>15){this._err("Invalid color mode.","parser");return}w=["Bitmap","Greyscale","Indexed","RGB","CMYK","HSL","HSB","Multichannel","Duotone","Lab","Greyscale16","RGB48","LAB48","CMYK64","DeepMultichannel","Duotone16"][v];q.channels=d;q.width=C;q.height=o;q.depth=j;q.byteWidth=j/8;q.colorMode=v;q.colorDesc=w;q.channelSize=C*o*q.byteWidth;e=n();a("ColorModeData",e);x+=e;if((v===2||v===8)&&e===0){this._err("Invalid size for PSD file.","parser");return}if(v===3){}else{if(v===8){}}r=n();a("ImageResource",r);x+=r;s=n();a("LayersAndMasks",s);x+=s;a("ImageData",B.buffer.byteLength-x);g=m();f=["Uncompressed","RLE","ZIP (no prediction)","ZIP"][g];q.compression=g;q.compressionDesc=f;switch(g){case 0:this._raw(B,x,q,h);break;case 1:this._rle(B,x,q,h);break;case 2:case 3:console.warn("If you come across this, consider sending us a specimen of this file for analysis.");break}function h(){u._toRGBA(c)}function c(i){u.rgba=i;if(u.onload){u.onload({timeStamp:Date.now(),elapsed:(performance?performance.now():Date.now())-z})}}function a(D,i){q.chunks.push({pos:x,name:D,length:i})}function m(){var i=B.getUint16(x);x+=2;return i>>>0}function n(){var i=B.getUint32(x);x+=4;return i>>>0}function k(D){var i=new Uint8Array(b,x,D);x+=D;return i}function l(D){var E=n(),i=String.fromCharCode;return D?i((E&255)>>>0)+i((E&65280)>>>8)+i((E&16711680)>>>16)+i((E&4278190080)>>>24):i((E&4278190080)>>>24)+i((E&16711680)>>>16)+i((E&65280)>>>8)+i((E&255)>>>0)}};PsdReader.prototype._rle=function(o,m,l,c){var d=0,k=l.channels,a=PsdReader._blockSize,n=new Uint8Array(o.buffer),h=o.buffer.byteLength,e=l.height*l.channels,b=new Uint16Array(e);while(d<e){b[d++]=j()}d=0;(function f(){var i=new Uint8Array(l.channelSize);l.bitmaps.push(i);g(n,i);a-=i.length;if(--k){if(a>0){f()}else{a=PsdReader._blockSize;setTimeout(f,PsdReader._delay)}}else{c()}})();function g(u,i){var t=0,q=l.height;while(q--){var r,w,s=Math.min(m+b[d++],h);while(m<s){r=u[m++];if(r>128){r=257-r;w=u[m++];while(r--){i[t++]=w}}else{if(r<128){r++;while(r--){i[t++]=u[m++]}}}}}}function j(){var i=o.getUint16(m);m+=2;return i}};PsdReader.prototype._raw=function(f,e,c,a){for(var b=0,d=c.channelSize;b<c.channels;b++,e+=d){c.bitmaps.push(new Uint8Array(f.buffer,e,d))}a()};PsdReader.prototype._toRGBA=function(h){var y=this,u=this.info,e=new Uint8ClampedArray(u.width*u.height<<2),w=e.length,z=u.colorMode,j=u.depth,f=u.byteWidth,B,n,d,c,s,A;switch(z){case 0:k(u.bitmaps[0],e,u.width<<2);h(e);return;case 1:B=n=d=u.bitmaps[0];c=u.bitmaps[1]||null;break;case 2:l(u.bitmaps[0],e,u.chunks[1]);h(e);return;case 3:case 4:case 5:case 6:B=u.bitmaps[0];n=u.bitmaps[1];d=u.bitmaps[2];c=u.bitmaps[4]||u.bitmaps[3]||null;break;case 7:B=u.bitmaps[0];n=u.bitmaps[1];d=u.bitmaps[2];break;case 8:h(null);return;case 9:m(e);h(e);return}A=0;if(j===32){B=new DataView(y.buffer,B.byteOffset,B.byteLength);if(n){n=new DataView(y.buffer,n.byteOffset,n.byteLength)}if(d){d=new DataView(y.buffer,d.byteOffset,d.byteLength)}if(c){c=new DataView(y.buffer,c.byteOffset,c.byteLength)}var o=1/((navigator.userAgent.indexOf("Mac OS")>-1)?1.8:2.2),x=new Uint8Array(256),C=0;for(;C<256;C++){x[C]=(Math.pow(C/255,o)*255+0.5)|0}if(c){if(z===3){for(s=0;s<w;A+=f){e[s++]=x[(B.getFloat32(A)*255+0.5)|0];e[s++]=x[(n.getFloat32(A)*255+0.5)|0];e[s++]=x[(d.getFloat32(A)*255+0.5)|0];e[s++]=x[(c.getFloat32(A)*255+0.5)|0]}}else{if(z===1){for(s=0;s<w;A+=f){var q=x[(B.getFloat32(A)*255+0.5)|0];e[s++]=q;e[s++]=q;e[s++]=q;e[s++]=c.getFloat32(A)*255}}}}else{for(s=0;s<w;A+=f){e[s++]=x[(B.getFloat32(A)*255+0.5)|0];e[s++]=x[(n.getFloat32(A)*255+0.5)|0];e[s++]=x[(d.getFloat32(A)*255+0.5)|0];e[s++]=255}}}else{if(c){for(s=0;s<w;A+=f){e[s++]=B[A];e[s++]=n[A];e[s++]=d[A];e[s++]=c[A]}}else{for(s=0;s<w;A+=f){e[s++]=B[A];e[s++]=n[A];e[s++]=d[A];e[s++]=255}}}h(e);function l(G,r,a){var F=G.length,b=a.length,p=b/3,g=p*2,I=new Uint8Array(y.buffer,a.pos,b),D=0,H=0,E;while(D<F){E=G[D++];r[H++]=I[E];r[H++]=I[E+p];r[H++]=I[E+g];r[H++]=255}}function k(E,g,G){var D=E.length,r=0,F=0,a;while(r<D){a=p();g[F++]=a;g[F++]=a;g[F++]=a;g[F++]=255;if(F%G===0){r=Math.ceil(r)}}function p(){var i=E[r|0],t=(r-(r|0))/0.125;r+=0.125;return(i&(128>>>t))?0:255}}function m(D){var G=u.bitmaps[0],g=u.bitmaps[1],t=u.bitmaps[2],r=u.bitmaps[3]||null,E,F=0,H=0;if(r){for(;F<w;H+=f){E=v(G[H],g[H],t[H]);D[F++]=E[0];D[F++]=E[1];D[F++]=E[2];D[F++]=r[H]}}else{for(;F<w;H+=f){E=v(G[H],g[H],t[H]);D[F++]=E[0];D[F++]=E[1];D[F++]=E[2];D[F++]=255}}}function v(t,g,i){t/=2.55;g=128-g;i=128-i;var H=(t+16)/116,E=g/500+H,J=H-i/200,F=Math.pow(E,3),I=Math.pow(H,3),K=Math.pow(J,3),D,r,p;H=(I>0.008855999999999999?I:(H-16/116)/7.787);E=(F>0.008855999999999999?F:(E-16/116)/7.787)*0.950456;J=(K>0.008855999999999999?K:(J-16/116)/7.787)*1.088754;D=E*3.2406+H*-1.5372+J*-0.4986;r=E*-0.9689+H*1.8758+J*0.0415;p=E*0.0557+H*-0.204+J*1.057;D=D>0.0031308?1.055*Math.pow(D,1/2.4)-0.055:12.92*D;r=r>0.0031308?1.055*Math.pow(r,1/2.4)-0.055:12.92*r;p=p>0.0031308?1.055*Math.pow(p,1/2.4)-0.055:12.92*p;return[(D*255+0.5)|0,(r*255+0.5)|0,(p*255+0.5)|0]}};PsdReader.prototype.toCanvas=function(a){if(!this.rgba){a(null);return}var b=document.createElement("canvas"),c=b.getContext("2d"),d;b.width=this.info.width;b.height=this.info.height;d=c.createImageData(b.width,b.height);d.data.set(this.rgba);c.putImageData(d,0,0);a({canvas:b,context:c,timeStamp:Date.now()})};