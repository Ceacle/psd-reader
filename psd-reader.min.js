/*
	psd-reader version 0.4.10 BETA

	By Epistemex (c) 2015
	www.epistemex.com

	MIT license (this header required)
*/
function PsdReader(f){f=f||{};var d=this,e,b={url:f.url||"",buffer:f.buffer||null,onError:f.onError||f.onerror,onLoad:f.onLoad||f.onload,onReady:f.onReady||f.onready,gamma:+f.gamma||1,gamma32:+f.gamma32||PsdReader.guessGamma(),duotone:f.duotone||[255,255,255],passive:!!f.passive,ignoreAlpha:!!f.ignoreAlpha,noRGBA:!!f.noRGBA};this._cfg=b;this.isParsed=!1;this._isp=!1;this.onready=e=b.onReady?b.onReady.bind(d):null;this.onload=b.onLoad?b.onLoad.bind(d):null;this.onerror=b.onError?b.onError.bind(d):null;this.buffer=b.buffer||null;this.rgba=null;this.info={width:0,height:0,channels:0,depth:0,indexes:0,byteWidth:0,colorMode:0,colorDesc:"",compression:0,compressionDesc:"",channelSize:0,chunks:[],bitmaps:[]};this._err=function(g,i){d._isp=!1;if(d.onerror){setTimeout(h.bind(d),1)}else{throw new TypeError(g)}function h(){d.onerror({message:g,source:i,timeStamp:Date.now()})}};function a(g){d._err(g,"core")}if((!b.url||typeof b.url!=="string"||(b.url&&!b.url.length))&&!d.buffer){a("Buffer nor URL specified");return}else{if(b.url&&d.buffer){a("Both URL and buffer specified");return}}try{if(b.url){d._fetch(b.url,function(g){d.buffer=g;d.view=new DataView(g);if(e){e({url:b.url,timeStamp:Date.now()})}if(!d._cfg.passive){d._parser(d.buffer)}},a)}else{if(e){e({url:null,timeStamp:Date.now()})}if(!d._cfg.passive){d._parser(d.buffer)}}}catch(c){a(c.message)}}PsdReader.prototype={parse:function(){var a=this;if(!a.isParsed&&!a._isp){a._parser(a.buffer)}},toRGBA:function(a){var c=this,b=a.bind(c);if(c._cfg.noRGBA&&!c.rgba){c._toRGBA(function(e){c.rgba=e;d()})}else{d()}function d(){b({rgba:c.rgba,timeStamp:Date.now()})}},getIndexTable:function(){var a=this.info.chunks[1];return a.length?new Uint8Array(this.buffer,a.pos,a.length):null},indexToInt:function(c,b,a){var d=4278190080+(c[b+512]<<16)+(c[b+256]<<8)+c[b];return a?d&16777215:d},getGammaLUT:function(a){var c=new Uint8ClampedArray(256),b=0;if(a===1){while(b<256){c[b]=b++}}else{for(;b<256;b++){c[b]=(Math.pow(b/255,a)*255+0.5)|0}}return c},floatToComp:function(a,b){return(a.getFloat32(b)*255+0.5)|0},_fetch:function(e,a,c){var d=this,f=new XMLHttpRequest();try{f.open("GET",e);f.responseType="arraybuffer";f.onerror=function(){d._err("Network error","fetch/err")};f.onload=function(){if(f.status===200){a(f.response)}else{d.error("Loading error: "+f.statusText,"fetch/load")}};f.send()}catch(b){d.error(b.message,"fetch/c")}},_chanToDV:function(a){return new DataView(a.buffer,a.byteOffset,a.byteLength)}};PsdReader.guessGamma=function(){return 1/((navigator.userAgent.indexOf("Mac OS")>-1)?1.8:2.2)};PsdReader._blockSize=2048*1024;PsdReader._delay=7;PsdReader.prototype._parser=function(c){var u=this,A=new DataView(c),x=0,t=k(),z=m(),e,g,B,p,i,v,w,f,r,s,y=performance?performance.now():Date.now(),q=this.info;u._isp=!0;this.findResource=j;if(t!=="8BPS"&&z!==1){a("Not a PSD file");return}if(n()||m()){a("Not a valid PSD file");return}b("Header",14);e=m();if(!e||e>56){a("Invalid channel count");return}p=n();B=n();if(!B||B>30000||!p||p>30000){a("Invalid size");return}i=m();if([1,8,16,32].indexOf(i)<0){a("Invalid depth");return}v=m();if(v>15){a("Invalid color mode");return}if([5,6,11,12,13,14,15].indexOf(v)>-1){a("Unsupported color mode");return}w=["Bitmap","Greyscale","Indexed","RGB","CMYK","HSL","HSB","Multichannel","Duotone","Lab","Greyscale16","RGB48","LAB48","CMYK64","DeepMultichannel","Duotone16"][v];q.channels=e;q.width=B;q.height=p;q.depth=i;q.byteWidth=i/8;q.colorMode=v;q.colorDesc=w;q.channelSize=B*p*q.byteWidth;f=n();b("ColorModeData",f);x+=f;if((v===2||v===8)&&f===0){a("Invalid data for mode.");return}r=n();b("ImageResource",r);x+=r;s=n();b("LayersAndMasks",s);x+=s;b("ImageData",A.buffer.byteLength-x);g=m();q.compression=g;q.compressionDesc=["Uncompressed","RLE","ZIP","ZIP"][g];switch(g){case 0:u._raw(A,x,q,h);break;case 1:u._rle(A,x,q,h);break;case 2:case 3:a("Unsupported compression");break}function h(){u._cfg.noRGBA?d(null):u._toRGBA(d)}function d(C){u._gamma(C);u.rgba=C;u.isParsed=!0;u._isp=!1;if(u.onload){u.onload({timeStamp:Date.now(),elapsed:(performance?performance.now():Date.now())-y})}}function j(D){var C=q.chunks[2],H,G=0,F,I,E;if(!C.length){return null}E=(D>>>8)|((D&255)<<8);H=new Uint16Array(u.buffer,C.pos,C.length>>1);F=H.length;while(G<F){I=H[G++];if(I===16952){I=H[G++];if(I===19785){I=H[G++];if(I===E){x=H.byteOffset+(G<<1);return{id:D,name:l(99),len:n(),pos:x}}}}}return null}function b(D,C){q.chunks.push({pos:x,name:D,length:C})}function o(){return A.getUint8(x++)}function m(){var C=A.getUint16(x);x+=2;return C>>>0}function n(){var C=A.getUint32(x);x+=4;return C>>>0}function l(F){var G="",C=-1,D=0,E;while(D++<F&&C){C=o();if(C>0){G+=String.fromCharCode(C)}}E=G.length;if(!E||E%2===0){x++}return G}function k(){var D=n(),C=String.fromCharCode;return C((D&4278190080)>>>24)+C((D&16711680)>>>16)+C((D&65280)>>>8)+C((D&255)>>>0)}function a(C){u._err(C,"parser")}};PsdReader.prototype._rle=function(o,m,l,c){var d=0,k=l.channels,a=PsdReader._blockSize,n=new Uint8Array(o.buffer),h=o.buffer.byteLength,e=l.height*l.channels,b=new Uint16Array(e);while(d<e){b[d++]=j()}d=0;(function f(){var i=new Uint8Array(l.channelSize);l.bitmaps.push(i);g(n,i,h);a-=i.length;if(--k){if(a>0){f()}else{a=PsdReader._blockSize;setTimeout(f,PsdReader._delay)}}else{c()}})();function g(x,i,q){var w=0,t,y,u,s=l.height,r;while(s--){u=Math.min(m+b[d++],q);while(m<u){t=x[m++];if(t>128){t=257-t;y=x[m++];r=w+t;while(w<r){i[w++]=y}}else{if(t<128){r=w+ ++t;while(w<r){i[w++]=x[m++]}}}}}}function j(){var i=o.getUint16(m);m+=2;return i}};PsdReader.prototype._raw=function(f,e,c,a){for(var b=0,d=c.channelSize;b<c.channels;b++,e+=d){c.bitmaps.push(new Uint8Array(f.buffer,e,d))}a()};PsdReader.prototype._toRGBA=function(d){var k=this,j=k.info,a=j.bitmaps,l=j.colorMode,b=j.byteWidth,c=k._chanToDV.bind(k),h=k.getGammaLUT,f=k.floatToComp,g=k._cfg.gamma32,i=k._cfg.ignoreAlpha,e=new Uint8ClampedArray(j.width*j.height<<2);switch(l){case 0:k._bitmap(a[0],e,j.width);break;case 1:k._grey(a,e,b,g,i,c,h,f);break;case 2:k._indexed(a[0],e,i);break;case 8:k._duotone(a,e,i);break;case 9:k._lab(a,e,b,i);break;default:k._rgba(a,e,b,g,i,c,h,f);break}d(e)};PsdReader.prototype._rgba=function(e,j,f,m,s,h,n,k){var v=this,t=j.length,q=0,w=0,x,l,d,c,o,u;x=e[0];l=e[1];d=e[2];c=e[4]||e[3];o=!!c&&!s;if(v.info.depth===32){x=h(x);l=h(l);d=h(d);if(o){c=h(c)}u=n(m);while(q<t){j[q++]=u[k(x,w)];j[q++]=u[k(l,w)];j[q++]=u[k(d,w)];j[q++]=o?u[k(c,w)]:255;w+=f}}else{while(q<t){j[q++]=x[w];j[q++]=l[w];j[q++]=d[w];j[q++]=o?c[w]:255;w+=f}}};PsdReader.prototype._grey=function(c,f,d,k,q,e,l,h){var r=f.length,o=0,t=0,j,b,m,n,s;j=c[0];b=c[1];n=!!b&&!q;if(this.info.depth===32){j=e(j);if(n){b=e(b)}s=l(k);while(o<r){m=s[h(j,t)];f[o++]=m;f[o++]=m;f[o++]=m;f[o++]=n?h(b,t):255;t+=d}}else{while(o<r){m=j[t];f[o++]=m;f[o++]=m;f[o++]=m;f[o++]=n?b[t]:255;t+=d}}};PsdReader.prototype._indexed=function(j,b,d){var h=this,f=j.length,k=h.getIndexTable(),n=new Uint32Array(b.buffer),c=0,e,a,g=-1,l=-1,m=d?null:h.findResource(1047);if(m){l=new DataView(h.buffer,m.pos,2).getInt16(0)}while(c<f){e=j[c];a=h.indexToInt(k,e,e===l);n[c++]=a;if(e>g){g=e}}h.info.indexes=++g};PsdReader.prototype._bitmap=function(f,a,j){var h=new Uint32Array(a.buffer),d=f.length,c=0,g=0,e=j;while(c<d){while(g<e){h[g++]=b(c);c+=0.125}c=Math.ceil(c);e+=j}function b(m){var k=f[m|0],l=(m-(m|0))/0.125;return(k&(128>>l))?4278190080:4294967295}};PsdReader.prototype._duotone=function(d,e,l){var q=d[0],a=d[1],j=!!a&&!l,s=this._cfg.duotone,h,o=s[0],f=s[1],c=s[2],k=0,n=0,m=q.length;while(k<m){h=q[k];e[n++]=((h*o)/255+0.5)|0;e[n++]=((h*f)/255+0.5)|0;e[n++]=((h*c)/255+0.5)|0;e[n++]=j?a[k]:255;k++}};PsdReader.prototype._lab=function(f,j,g,m){var n=f[0],c=f[1],e=f[2],d=f[3],k=!!d&!m,q=j.length,h,l=0,r=0;for(;l<q;r+=g,l+=4){h=o(n[r]/2.55,c[r]-128,e[r]-128,j,l);j[l+3]=k?d[r]:255}function o(A,p,s,u,w){var F=(A+16)/116,D=p/500+F,I=F-s/200,E=Math.pow(D,3),H=Math.pow(F,3),J=Math.pow(I,3),C,v,t;F=(H>0.008855999999999999?H:(F-0.137931)/7.787);D=(E>0.008855999999999999?E:(D-0.137931)/7.787)*0.950456;I=(J>0.008855999999999999?J:(I-0.137931)/7.787)*1.088754;C=D*3.2406+F*-1.5372+I*-0.4986;v=D*-0.9689+F*1.8758+I*0.0415;t=D*0.0557+F*-0.204+I*1.057;C=C>0.0031308?1.055*Math.pow(C,0.41667)-0.055:12.92*C;v=v>0.0031308?1.055*Math.pow(v,0.41667)-0.055:12.92*v;t=t>0.0031308?1.055*Math.pow(t,0.41667)-0.055:12.92*t;u[w++]=C*255;u[w++]=v*255;u[w]=t*255}};PsdReader.prototype._gamma=function(a){if(!a){return}var c=this._cfg.gamma,b=this.info.depth,e=a.length,d=0,f;if(c&&c!==1&&b<32){f=this.getGammaLUT(c);d=0;while(d<e){a[d]=f[a[d++]];a[d]=f[a[d++]];a[d]=f[a[d++]];d++}}};PsdReader.prototype.toCanvas=function(k){if(!this.rgba){return null}k=k||{};var i=this,a=document.createElement("canvas"),b=a.getContext("2d"),g,q,r,o,m=k.scale||1,f=!!k.hq,s=i.info.width,e=i.info.height,l,j,p=(s*m+0.5)|0,n=(e*m+0.5)|0,d="Could not create canvas";try{a.width=s;a.height=e;g=b.createImageData(s,e);g.data.set(i.rgba);b.putImageData(g,0,0)}catch(c){i._err(d,"toCanvas")}try{if(m!==1){q=document.createElement("canvas");r=q.getContext("2d");if(f&&p<s&&n<e){s=q.width=Math.ceil(s*0.5);e=q.height=Math.ceil(e*0.5);r.drawImage(a,0,0,s,e);o=Math.ceil(Math.log(a.width/p)/Math.log(2))-1;if(o>0){while(o--){l=s;j=e;s=Math.ceil(s*0.5);e=Math.ceil(e*0.5);r.drawImage(q,0,0,l,j,0,0,s,e)}}a.width=p;a.height=n;b.drawImage(q,0,0,s,e,0,0,p,n)}else{q.width=p;q.height=n;r.drawImage(a,0,0,p,n);a=q}}}catch(c){i._err(d,"toCanvas/s")}return a};