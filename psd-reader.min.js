/*
	psd-reader version 0.4.6 BETA

	By Epistemex (c) 2015
	www.epistemex.com

	MIT license (this header required)
*/
function PsdReader(e){e=e||{};var d=this,a={url:e.url||"",buffer:e.buffer||null,onError:e.onError||e.onerror,onLoad:e.onLoad||e.onload,onReady:e.onReady||e.onready,gamma:+e.gamma||1,gamma32:+e.gamma32||PsdReader.guessGamma(),duotone:e.duotone||[255,255,255],passive:!!e.passive};this._cfg=a;this.isParsed=!1;this._isParsing=!1;this.onready=a.onReady?a.onReady.bind(d):null;this.onload=a.onLoad?a.onLoad.bind(d):null;this.onerror=a.onError?a.onError.bind(d):null;this.buffer=a.buffer||null;this.rgba=null;this.info={width:0,height:0,channels:0,depth:0,indexes:0,byteWidth:0,colorMode:0,colorDesc:"",compression:0,compressionDesc:"",channelSize:0,chunks:[],bitmaps:[]};if((!a.url||typeof a.url!=="string"||(a.url&&!a.url.length))&&!d.buffer){c("Buffer nor URL specified.","core");return}else{if(a.url&&d.buffer){c("Both URL and buffer specified.","core");return}}this._err=c;try{if(a.url){d._fetch(a.url,function(f){d.buffer=f;d.view=new DataView(f);if(d.onready){d.onready({timeStamp:Date.now()})}if(!d._cfg.passive){d._parser(d.buffer)}},c)}else{if(d.onready){d.onready({timeStamp:Date.now()})}if(!d._cfg.passive){d._parser(d.buffer)}}}catch(b){c(b.message,"core")}function c(g,h){d._isParsing=!1;if(d.onerror){setTimeout(f.bind(d),1)}else{throw new TypeError(g)}function f(){d.onerror({message:g,source:h,timeStamp:Date.now()})}}}PsdReader.prototype={parse:function(){var a=this;if(!a.isParsed&&!a._isParsing){a._parser(a.buffer)}},getIndexTable:function(){var a=this.info.chunks[1];return a.length?new Uint8Array(this.buffer,a.pos,a.length):null},indexToInt:function(c,b,a){var d=4278190080+(c[b+512]<<16)+(c[b+256]<<8)+c[b];return a?d&16777215:d},getGammaLUT:function(a){for(var c=new Uint8ClampedArray(256),b=0;b<256;b++){c[b]=(Math.pow(b/255,a)*255+0.5)|0}return c},floatToComp:function(a,b){return(a.getFloat32(b)*255+0.5)|0},_fetch:function(e,a,c){var d=this,f=new XMLHttpRequest();try{f.open("GET",e);f.responseType="arraybuffer";f.onerror=function(){d._err("Network error","fetch/err")};f.onload=function(){if(f.status===200){a(f.response)}else{d.error("Loading error: "+f.statusText,"fetch/load")}};f.send()}catch(b){d.error(b.message,"fetch/c")}},_chanToDV:function(a){return new DataView(a.buffer,a.byteOffset,a.byteLength)}};PsdReader.guessGamma=function(){return 1/((navigator.userAgent.indexOf("Mac OS")>-1)?1.8:2.2)};PsdReader._blockSize=2048*1024;PsdReader._delay=7;PsdReader.prototype._parser=function(b){var w=this,D=new DataView(b),z=0,v=l(),C=n(),A,r,d,f,E,q,h,x,y,e,t,u,B=performance?performance.now():Date.now(),s=this.info;w._isParsing=!0;this.findResource=j;if(v!=="8BPS"&&C!==1){w._err("Not PSD file.","parser");return}for(A=k(6),r=0;r<6;r++){if(A[r]){w._err("Not a valid PSD file.","parser");return}}a("Header",14);d=n();if(d<1||d>56){w._err("Invalid channel count.","parser");return}q=o();E=o();if(E<1||E>30000||q<1||q>30000){w._err("Invalid size.","parser");return}h=n();if([1,8,16,32].indexOf(h)<0){w._err("Invalid depth.","parser");return}x=n();if(x<0||x>15){w._err("Invalid color mode.","parser");return}y=["Bitmap","Greyscale","Indexed","RGB","CMYK","HSL","HSB","Multichannel","Duotone","Lab","Greyscale16","RGB48","LAB48","CMYK64","DeepMultichannel","Duotone16"][x];s.channels=d;s.width=E;s.height=q;s.depth=h;s.byteWidth=h/8;s.colorMode=x;s.colorDesc=y;s.channelSize=E*q*s.byteWidth;e=o();a("ColorModeData",e);z+=e;if((x===2||x===8)&&e===0){w._err("Invalid data for mode.","parser");return}t=o();a("ImageResource",t);z+=t;u=o();a("LayersAndMasks",u);z+=u;a("ImageData",D.buffer.byteLength-z);f=n();s.compression=f;s.compressionDesc=["Uncompressed","RLE","ZIP","ZIP"][f];switch(f){case 0:w._raw(D,z,s,g);break;case 1:w._rle(D,z,s,g);break;case 2:case 3:console.warn("Not supported.");break}function g(){w._toRGBA(c)}function c(i){w._gamma(i);w.rgba=i;w.isParsed=!0;w._isParsing=!1;if(w.onload){w.onload({timeStamp:Date.now(),elapsed:(performance?performance.now():Date.now())-B})}}function j(F){var i=s.chunks[2],J,I=0,H,K,G;if(!i.length){return null}G=(F>>>8)|((F&255)<<8);J=new Uint16Array(w.buffer,i.pos,i.length>>>1);H=J.length;while(I<H){K=J[I++];if(K===16952){K=J[I++];if(K===19785){K=J[I++];if(K===G){z=J.byteOffset+(I<<1);return{id:F,name:m(512),len:o(),pos:z}}}}}return null}function a(F,i){s.chunks.push({pos:z,name:F,length:i})}function p(){return D.getUint8(z++)}function n(){var i=D.getUint16(z);z+=2;return i>>>0}function o(){var i=D.getUint32(z);z+=4;return i>>>0}function k(F){var i=new Uint8Array(b,z,F);z+=F;return i}function m(I){var J="",F=-1,G=0,H;while(G++<I&&F){F=p();if(F>0){J+=String.fromCharCode(F)}}H=J.length;if(!H||H%2===0){z++}return J}function l(){var F=o(),i=String.fromCharCode;return i((F&4278190080)>>>24)+i((F&16711680)>>>16)+i((F&65280)>>>8)+i((F&255)>>>0)}};PsdReader.prototype._rle=function(o,m,l,c){var d=0,k=l.channels,a=PsdReader._blockSize,n=new Uint8Array(o.buffer),h=o.buffer.byteLength,e=l.height*l.channels,b=new Uint16Array(e);while(d<e){b[d++]=j()}d=0;(function f(){var i=new Uint8Array(l.channelSize);l.bitmaps.push(i);g(n,i,h);a-=i.length;if(--k){if(a>0){f()}else{a=PsdReader._blockSize;setTimeout(f,PsdReader._delay)}}else{c()}})();function g(x,i,q){var w=0,t,y,u,s=l.height,r;while(s--){u=Math.min(m+b[d++],q);while(m<u){t=x[m++];if(t>128){t=257-t;y=x[m++];r=w+t;while(w<r){i[w++]=y}}else{if(t<128){r=w+ ++t;while(w<r){i[w++]=x[m++]}}}}}}function j(){var i=o.getUint16(m);m+=2;return i}};PsdReader.prototype._raw=function(f,e,c,a){for(var b=0,d=c.channelSize;b<c.channels;b++,e+=d){c.bitmaps.push(new Uint8Array(f.buffer,e,d))}a()};PsdReader.prototype._toRGBA=function(b){var e=this,d=e.info,a=d.bitmaps,f=d.colorMode,c=new Uint8ClampedArray(d.width*d.height<<2);switch(f){case 0:e._bitmap(a[0],c,d.width);break;case 2:e._indexed(a[0],c);break;case 8:e._duotone(c);break;case 9:e._lab(c);break;default:e._rgba(a,c,f===1);break}b(c)};PsdReader.prototype._rgba=function(e,j,t){var w=this,s=w.info,h=w._chanToDV.bind(w),x=s.colorMode,f=s.byteWidth,u=j.length,q=0,y=0,z,l,d,c,n,o,m,v,k;z=e[0];l=e[1];d=e[2];c=e[4]||e[(t?1:3)];o=!!c;if(s.depth===32){z=h(z);if(o){c=h(c)}m=w._cfg.gamma32;v=w.getGammaLUT(m);k=w.floatToComp;if(x===3){if(l){l=h(l)}if(d){d=h(d)}while(q<u){j[q++]=v[k(z,y)];j[q++]=v[k(l,y)];j[q++]=v[k(d,y)];j[q++]=o?v[k(c,y)]:255;y+=f}}else{while(q<u){n=v[k(z,y)];j[q++]=n;j[q++]=n;j[q++]=n;j[q++]=o?k(c,y):255;y+=f}}}else{if(x===1){while(q<u){n=z[y];j[q++]=n;j[q++]=n;j[q++]=n;j[q++]=o?c[y]:255;y+=f}}else{while(q<u){j[q++]=z[y];j[q++]=l[y];j[q++]=d[y];j[q++]=o?c[y]:255;y+=f}}}};PsdReader.prototype._indexed=function(j,b){var h=this,f=j.length,k=h.getIndexTable(),c=h.indexToInt,n=new Uint32Array(b.buffer),d=0,e,a,g=-1,l=-1,m=h.findResource(1047);if(m){l=new DataView(h.buffer,m.pos,2).getInt16(0)}while(d<f){e=j[d];a=c(k,e,e===l);n[d++]=a;if(e>g){g=e}}h.info.indexes=++g};PsdReader.prototype._bitmap=function(e,a,h){var g=new Uint32Array(a.buffer),d=e.length,c=0,f=0;while(c<d){g[f++]=b();if(f%h===0){c=Math.ceil(c)}}function b(){var i=e[c|0],j=(c-(c|0))/0.125;c+=0.125;return(i&(128>>j))?4278190080:4294967295}};PsdReader.prototype._duotone=function(e){var d=this.info.bitmaps,o=d[0],a=d[1],j=!!a,q=this._cfg.duotone,h,n=q[0],f=q[1],c=q[2],k=0,m=0,l=o.length;while(k<l){h=o[k];e[m++]=((h*n)/255+0.5)|0;e[m++]=((h*f)/255+0.5)|0;e[m++]=((h*c)/255+0.5)|0;e[m++]=j?a[k]:255;k++}};PsdReader.prototype._lab=function(j){var f=this.info.bitmaps,m=f[0],c=f[1],e=f[2],d=f[3]||null,g=this.info.byteWidth,k=!!d,o=j.length,h,l=0,q=0;for(;l<o;q+=g){h=n(m[q],c[q],e[q]);j[l++]=h[0];j[l++]=h[1];j[l++]=h[2];j[l++]=k?d[q]:255}function n(t,i,p){t/=2.55;i=(i-128)/1.16;p=(p-128)/1.16;var A=(t+16)/116,v=i/500+A,D=A-p/200,w=Math.pow(v,3),C=Math.pow(A,3),E=Math.pow(D,3),u,s,r;A=(C>0.008855999999999999?C:(A-16/116)/7.787);v=(w>0.008855999999999999?w:(v-16/116)/7.787)*0.950456;D=(E>0.008855999999999999?E:(D-16/116)/7.787)*1.088754;u=v*3.2406+A*-1.5372+D*-0.4986;s=v*-0.9689+A*1.8758+D*0.0415;r=v*0.0557+A*-0.204+D*1.057;u=u>0.0031308?1.055*Math.pow(u,0.41667)-0.055:12.92*u;s=s>0.0031308?1.055*Math.pow(s,0.41667)-0.055:12.92*s;r=r>0.0031308?1.055*Math.pow(r,0.41667)-0.055:12.92*r;return[u*255+0.5,s*255+0.5,r*255+0.5]}};PsdReader.prototype._gamma=function(a){if(!a){return}var c=this._cfg.gamma,b=this.info.depth,e=a.length,d=0,f;if(c&&c!==1&&b<32){f=this.getGammaLUT(c);d=0;while(d<e){a[d]=f[a[d++]];a[d]=f[a[d++]];a[d]=f[a[d++]];d++}}};PsdReader.prototype.toCanvas=function(k){if(!this.rgba){return null}k=k||{};var i=this,a=document.createElement("canvas"),b=a.getContext("2d"),g,q,r,o,m=k.scale||1,f=!!k.hq,s=i.info.width,e=i.info.height,l,j,p=(s*m+0.5)|0,n=(e*m+0.5)|0,d="Could not create canvas";try{a.width=s;a.height=e;g=b.createImageData(s,e);g.data.set(i.rgba);b.putImageData(g,0,0)}catch(c){i._err(d,"toCanvas")}try{if(m!==1){q=document.createElement("canvas");r=q.getContext("2d");if(f&&p<s&&n<e){s=q.width=Math.ceil(s*0.5);e=q.height=Math.ceil(e*0.5);r.drawImage(a,0,0,s,e);o=Math.ceil(Math.log(a.width/p)/Math.log(2))-1;if(o>0){while(o--){l=s;j=e;s=Math.ceil(s*0.5);e=Math.ceil(e*0.5);r.drawImage(q,0,0,l,j,0,0,s,e)}}a.width=p;a.height=n;b.drawImage(q,0,0,s,e,0,0,p,n)}else{q.width=p;q.height=n;r.drawImage(a,0,0,p,n);a=q}}}catch(c){i._err(d,"toCanvas/s")}return a};