/*
	psd-reader version 0.4.1 BETA

	By Epistemex (c) 2015
	www.epistemex.com

	MIT license (this header required)
*/
function PsdReader(e){e=e||{};var d=this,a={url:e.url||"",buffer:e.buffer||null,onError:e.onError||e.onerror,onLoad:e.onLoad||e.onload,onReady:e.onReady||e.onready,gamma:+e.gamma||1,gamma32:+e.gamma32||PsdReader.guessGamma(),duotone:e.duotone||[255,255,255],passive:!!e.passive};this._cfg=a;this.isParsed=!1;this._isParsing=!1;this.onready=a.onReady?a.onReady.bind(d):null;this.onload=a.onLoad?a.onLoad.bind(d):null;this.onerror=a.onError?a.onError.bind(d):null;this.buffer=a.buffer?(ArrayBuffer.isView(a.buffer)?a.buffer.buffer:a.buffer):null;this.rgba=null;this.info={width:0,height:0,channels:0,depth:0,indexes:0,byteWidth:0,colorMode:0,colorDesc:"",compression:0,compressionDesc:"",channelSize:0,chunks:[],bitmaps:[]};if((!a.url||typeof a.url!=="string"||(a.url&&!a.url.length))&&!d.buffer){c("Buffer or URL not specified.","core");return}else{if(a.url&&d.buffer){c("Both URL and buffer specified.","core");return}}this._err=c;try{if(a.url){d._fetch(a.url,function(f){d.buffer=f;d.view=new DataView(f);if(d.onready){d.onready({timeStamp:Date.now()})}if(!d._cfg.passive){d._parser(d.buffer)}},c)}else{if(d.onready){d.onready({timeStamp:Date.now()})}if(!d._cfg.passive){d._parser(d.buffer)}}}catch(b){c(b.message,"core")}function c(g,h){d._isParsing=!1;if(d.onerror){setTimeout(f.bind(d),1)}else{throw new TypeError(g)}function f(){d.onerror({message:g,source:h,timeStamp:Date.now()})}}}PsdReader.prototype={parse:function(){var a=this;if(!a.isParsed&&!a._isParsing){a._parser(a.buffer)}},_fetch:function(e,a,c){try{var f=new XMLHttpRequest(),d=this;f.open("GET",e);f.responseType="arraybuffer";f.onerror=function(){d._err("Network error.","fetch/onerror")};f.onload=function(){if(f.status===200){a(f.response)}else{d.error("Loading error: "+f.statusText,"fetch/onload")}};f.send()}catch(b){this.error(b.message,"fetch/catch")}}};PsdReader.guessGamma=function(){return 1/((navigator.userAgent.indexOf("Mac OS")>-1)?1.8:2.2)};PsdReader._blockSize=2048*1024;PsdReader._delay=7;PsdReader.prototype._parser=function(b){var w=this,D=new DataView(b),z=0,v=l(),C=n(),A,r,d,f,E,q,h,x,y,e,t,u,B=performance?performance.now():Date.now(),s=this.info;w._isParsing=!0;this.findResource=j;if(v!=="8BPS"&&C!==1){w._err("Not PSD file.","parser");return}for(A=k(6),r=0;r<6;r++){if(A[r]){w._err("Not a valid PSD file.","parser");return}}a("Header",14);d=n();if(d<1||d>56){w._err("Invalid channel count.","parser");return}q=o();E=o();if(E<1||E>30000||q<1||q>30000){w._err("Invalid size.","parser");return}h=n();if([1,8,16,32].indexOf(h)<0){w._err("Invalid depth.","parser");return}x=n();if(x<0||x>15){w._err("Invalid color mode.","parser");return}y=["Bitmap","Greyscale","Indexed","RGB","CMYK","HSL","HSB","Multichannel","Duotone","Lab","Greyscale16","RGB48","LAB48","CMYK64","DeepMultichannel","Duotone16"][x];s.channels=d;s.width=E;s.height=q;s.depth=h;s.byteWidth=h/8;s.colorMode=x;s.colorDesc=y;s.channelSize=E*q*s.byteWidth;e=o();a("ColorModeData",e);z+=e;if((x===2||x===8)&&e===0){w._err("Invalid data for mode.","parser");return}t=o();a("ImageResource",t);z+=t;u=o();a("LayersAndMasks",u);z+=u;a("ImageData",D.buffer.byteLength-z);f=n();s.compression=f;s.compressionDesc=["Uncompressed","RLE","ZIP","ZIP"][f];switch(f){case 0:w._raw(D,z,s,g);break;case 1:w._rle(D,z,s,g);break;case 2:case 3:console.warn("Not supported.");break}function g(){w._toRGBA(c)}function c(i){w._gamma(i);w.rgba=i;w.isParsed=!0;w._isParsing=!1;if(w.onload){w.onload({timeStamp:Date.now(),elapsed:(performance?performance.now():Date.now())-B})}}function j(F){var i=s.chunks[2],J,I=0,H,K,G;if(!i.length){return null}G=((F&65280)>>>8)|((F&255)<<8);J=new Uint16Array(w.buffer,i.pos,i.length>>>1);H=J.length;while(I<H){K=J[I++];if(K===16952){K=J[I++];if(K===19785){K=J[I++];if(K===G){z=J.byteOffset+(I<<1);return{offset:z,id:F,name:m(),len:o(),pos:z}}}}}return null}function a(F,i){s.chunks.push({pos:z,name:F,length:i})}function p(){return D.getUint8(z++)}function n(){var i=D.getUint16(z);z+=2;return i>>>0}function o(){var i=D.getUint32(z);z+=4;return i>>>0}function k(F){var i=new Uint8Array(b,z,F);z+=F;return i}function m(I){var J="",F=-1,G=0,H;I=I||255;while(G++<I&&F){F=p();if(F>0){J+=String.fromCharCode(F)}}H=J.length;if(!H||H%2===0){z++}return J}function l(){var F=o(),i=String.fromCharCode;return i((F&4278190080)>>>24)+i((F&16711680)>>>16)+i((F&65280)>>>8)+i((F&255)>>>0)}};PsdReader.prototype._rle=function(o,m,l,c){var d=0,k=l.channels,a=PsdReader._blockSize,n=new Uint8Array(o.buffer),h=o.buffer.byteLength,e=l.height*l.channels,b=new Uint16Array(e);while(d<e){b[d++]=j()}d=0;(function f(){var i=new Uint8Array(l.channelSize);l.bitmaps.push(i);g(n,i);a-=i.length;if(--k){if(a>0){f()}else{a=PsdReader._blockSize;setTimeout(f,PsdReader._delay)}}else{c()}})();function g(u,i){var t=0,q=l.height;while(q--){var r,w,s=Math.min(m+b[d++],h);while(m<s){r=u[m++];if(r>128){r=257-r;w=u[m++];while(r--){i[t++]=w}}else{if(r<128){r++;while(r--){i[t++]=u[m++]}}}}}}function j(){var i=o.getUint16(m);m+=2;return i}};PsdReader.prototype._raw=function(f,e,c,a){for(var b=0,d=c.channelSize;b<c.channels;b++,e+=d){c.bitmaps.push(new Uint8Array(f.buffer,e,d))}a()};PsdReader.prototype._toRGBA=function(l){var x=this,u=x.info,h=u.bitmaps,f=new Uint8ClampedArray(u.width*u.height<<2),k=x.channelToDataView.bind(x),v=f.length,y=u.colorMode,m=u.depth,d,j=u.byteWidth,A,o,e,c,t=0,z=0,s,q,w,n;switch(y){case 0:x._bitmap(h[0],f,u.width);l(f);return;case 1:A=h[0];c=h[1]||null;break;case 2:x._indexed(h[0],f);l(f);return;case 3:case 4:case 5:case 6:case 7:A=h[0];o=h[1];e=h[2];c=h[4]||h[3]||null;break;case 8:x._duotone(f);l(f);return;case 9:x._lab(f);l(f);return}d=!!c;if(m===32){A=k(A);if(o){o=k(o)}if(e){e=k(e)}if(c){c=k(c)}q=x._cfg.gamma32;w=x.getGammaLUT(q);n=x.floatToComp;if(y===3){while(t<v){f[t++]=w[n(A,z)];f[t++]=w[n(o,z)];f[t++]=w[n(e,z)];f[t++]=d?w[n(c,z)]:255;z+=j}}else{while(t<v){s=w[(A.getFloat32(z)*255+0.5)|0];f[t++]=s;f[t++]=s;f[t++]=s;f[t++]=d?c.getFloat32(z)*255:255;z+=j}}}else{if(y===1){while(t<v){s=A[z];f[t++]=s;f[t++]=s;f[t++]=s;f[t++]=d?c[z]:255;z+=j}}else{while(t<v){f[t++]=A[z];f[t++]=o[z];f[t++]=e[z];f[t++]=d?c[z]:255;z+=j}}}l(f)};PsdReader.prototype._indexed=function(j,b){var h=this,f=j.length,k=h.getIndexTable(),c=h.indexToInt,n=new Uint32Array(b.buffer),d=0,e,a,g=-1,l=-1,o,m=h.findResource(1047);if(m){o=new DataView(h.buffer,m.pos,2);l=o.getInt16(0)}while(d<f){e=j[d];a=c(k,e);if(e===l){a&=16777215}n[d++]=a;if(e>g){g=e}}h.info.indexes=++g};PsdReader.prototype._bitmap=function(e,a,h){var g=new Uint32Array(a.buffer),d=e.length,c=0,f=0;while(c<d){g[f++]=b();if(f%h===0){c=Math.ceil(c)}}function b(){var i=e[c|0],j=(c-(c|0))/0.125;c+=0.125;return(i&(128>>>j))?4278190080:4294967295}};PsdReader.prototype._duotone=function(f){var j=this.info.bitmaps[0],c=this.info.bitmaps[1]||null,d=!!c,q=this._cfg.duotone,k,o=q[0],h=q[1],e=q[2],l=0,n=0,m=j.length;while(l<m){k=j[l];f[n++]=((k*o)/255+0.5)|0;f[n++]=((k*h)/255+0.5)|0;f[n++]=((k*e)/255+0.5)|0;f[n++]=d?c[l]:255;l++}};PsdReader.prototype._lab=function(f){var g=this.info.bitmaps,m=g[0],c=g[1],e=g[2],d=g[3]||null,h=this.info.byteWidth,k=!!d,o=f.length,j,l=0,q=0;for(;l<o;q+=h){j=n(m[q],c[q],e[q]);f[l++]=j[0];f[l++]=j[1];f[l++]=j[2];f[l++]=k?d[q]:255}function n(t,i,p){t/=2.55;i=128-i;p=128-p;var A=(t+16)/116,v=i/500+A,D=A-p/200,w=Math.pow(v,3),C=Math.pow(A,3),E=Math.pow(D,3),u,s,r;A=(C>0.008855999999999999?C:(A-16/116)/7.787);v=(w>0.008855999999999999?w:(v-16/116)/7.787)*0.950456;D=(E>0.008855999999999999?E:(D-16/116)/7.787)*1.088754;u=v*3.2406+A*-1.5372+D*-0.4986;s=v*-0.9689+A*1.8758+D*0.0415;r=v*0.0557+A*-0.204+D*1.057;u=u>0.0031308?1.055*Math.pow(u,1/2.4)-0.055:12.92*u;s=s>0.0031308?1.055*Math.pow(s,1/2.4)-0.055:12.92*s;r=r>0.0031308?1.055*Math.pow(r,1/2.4)-0.055:12.92*r;return[(r*255+0.5)|0,(s*255+0.5)|0,(u*255+0.5)|0]}};PsdReader.prototype._gamma=function(a){if(!a){return}var c=this._cfg.gamma,b=this.info.depth,e=a.length,d=0,f;if(c&&c!==1&&b<32){f=this.getGammaLUT(c);while(d<e){a[d]=f[a[d++]];a[d]=f[a[d++]];a[d]=f[a[d++]];d++}}};PsdReader.prototype.toCanvas=function(k){if(!this.rgba){return null}k=k||{};var i=this,a=document.createElement("canvas"),b=a.getContext("2d"),q,r,o,g,m=k.scale||1,f=!!k.hq,s=i.info.width,e=i.info.height,l,j,p=(s*m+0.5)|0,n=(e*m+0.5)|0,d="Could not create canvas";try{a.width=s;a.height=e;g=b.createImageData(s,e);g.data.set(i.rgba);b.putImageData(g,0,0)}catch(c){i._err(d,"toCanvas")}try{if(m!==1){q=document.createElement("canvas");r=q.getContext("2d");if(f){s=q.width=Math.ceil(s*0.5);e=q.height=Math.ceil(e*0.5);r.drawImage(a,0,0,s,e);o=Math.ceil(Math.log(a.width/p)/Math.log(2))-1;if(o>0){while(o--){l=s;j=e;s=Math.ceil(s*0.5);e=Math.ceil(e*0.5);r.drawImage(q,0,0,l,j,0,0,s,e)}}a.width=p;a.height=n;b.drawImage(q,0,0,s,e,0,0,p,n)}else{q.width=p;q.height=n;r.drawImage(a,0,0,p,n);a=q}}}catch(c){i._err(d,"toCanvas/s")}return a};PsdReader.prototype.getIndexTable=function(){var a=this.info.chunks[1];if(a.length){return new Uint8Array(this.buffer,a.pos,a.length)}return null};PsdReader.prototype.indexToInt=function(b,a){return 4278190080+(b[a+512]<<16)+(b[a+256]<<8)+b[a]};PsdReader.prototype.channelToDataView=function(a){return new DataView(a.buffer,a.byteOffset,a.byteLength)};PsdReader.prototype.getGammaLUT=function(a){var c=new Uint8ClampedArray(256),b;for(b=0;b<256;b++){c[b]=(Math.pow(b/255,a)*255+0.5)|0}return c};PsdReader.prototype.floatToComp=function(a,b){return(a.getFloat32(b)*255+0.5)|0};